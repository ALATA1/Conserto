pipeline {
    agent any

    environment {
        PYTHON = 'C:\\Users\\ibrahima.alata\\AppData\\Local\\Programs\\Python\\Python313\\python.exe'
        RESULTS_DIR = 'Resultats'
        ALLURE_RESULTS_DIR = 'Resultats'
        ALLURE_REPORT_DIR = 'Resultats'
    }

    triggers {
        cron('H 7 * * 1-5')  // Tous les jours ouvrÃ©s Ã  8h
    }

    parameters {
        string(name: 'EMAIL', defaultValue: 'ibrahima.alata@conserto.pro', description: 'Destinataire du rapport')
    }

    tools {
        allure 'Allure' // nom que tu as mis dans l'Ã©tape prÃ©cÃ©dente
    }

    stages {
        stage('Installation des dÃ©pendances') {
            steps {
                echo 'Installation des librairies'
                bat "${env.PYTHON} -m pip install --upgrade pip"
                bat "${env.PYTHON} -m pip install -r requirements.txt"
            }
        }

        stage('ExÃ©cution des tests') {
            steps {
                echo 'Lancement des tests'
                // bat "${env.PYTHON} -m robot --outputdir Resultats Tests"
                // bat "${env.PYTHON} -m robot --outputdir Resultats Tests/TestSuites/Conserto/conserto_1.robot"
                // bat "${env.PYTHON} -m robot --outputdir Resultats --listener allure_robotframework; Tests/"
                // bat "\"%PYTHON%\" -m robot --listener allure_robotframework;%ALLURE_RESULTS_DIR% --outputdir %RESULTS_DIR% Tests"
                bat "${env.PYTHON} -m robot --listener allure_robotframework;allure-results Tests/TestSuites/Conserto/Conserto_1.robot"

            }          
        }

        stage('GÃ©nÃ©rer rapport Allure') {
            steps {
                echo 'GÃ©nÃ©ration du rapport Allure...'
                // bat "allure generate %ALLURE_RESULTS_DIR% -o %ALLURE_REPORT_DIR% --clean"
                // bat 'C:\\tools\\allure\\bin\\allure.bat generate Resultats -o Resultats --clean'
                bat 'C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\tools\\allure\\bin\\allure.bat generate allure-results -o allure-report --clean'
                // bat 'C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\tools\\allure\\bin\\allure.bat open allure-report'
            }
        }

    

        stage('Rapport-Publisher') {
            steps {
                echo 'Pipeline terminÃ©.'
                robot outputPath: 'Resultats'
                archiveArtifacts artifacts: 'Resultats/*.html'
                // archiveArtifacts artifacts: 'allure-report/**/*.*, Resultats/*.html', fingerprint: true
            }
        }
    }

    post {

        // always {
        //      allure includeProperties: false, jdk: '', results: [[path: 'allure-results']]
        // }
        // always {
        //     script {
        //         if (fileExists('allure-results')) {
        //             allure results: [[path: 'allure-results']]
        //         } else {
        //             echo 'Pas de rÃ©sultats Allure Ã  afficher'
        //         }
        //     }
        // }

        always {
            script {
                def allureDir = new File('allure-results')
                if (allureDir.exists() && allureDir.list().length > 0) {
                    echo "RÃ©sultats Allure trouvÃ©s : ${allureDir.list().length} fichiers"
                    allure results: [[path: 'allure-results']]
                } else {
                    echo 'ğŸ“­ Aucun rÃ©sultat Allure Ã  publier (dossier vide ou manquant)'
                }
            }
        }

        success {
            emailext (
                subject: "âœ… SUCCÃˆS - Rapport de test ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    Bonjour,

                    Le build *${env.JOB_NAME}* #${env.BUILD_NUMBER} a Ã©tÃ© exÃ©cutÃ© avec **succÃ¨s**.

                    ğŸ“ Rapport HTML : ${env.BUILD_URL}artifact/Resultats/log.html  
                    ğŸ“ Rapport ZIP en piÃ¨ce jointe.
                    ğŸ“ Rapport Robot : <a href="${env.BUILD_URL}artifact/Resultats/log.html">log.html</a><br>
                    ğŸ“Š Rapport Allure : <a href="${env.BUILD_URL}artifact/allure-report/index.html">index.html</a><br><br>

                    Cordialement,  
                    Jenkins
                """,
                mimeType: 'text/html',
                to: "${params.EMAIL}",
                attachmentsPattern: 'Resultats/rapport_robot.zip'
            )
        }

        failure {
            emailext (
                subject: "âŒ Ã‰CHEC - Rapport de test ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    Bonjour,

                    Le build *${env.JOB_NAME}* #${env.BUILD_NUMBER} a Ã©chouÃ©.

                    ğŸ“ Voir logs ici : ${env.BUILD_URL}console  
                    ğŸ“ Rapport HTML (s'il existe) : ${env.BUILD_URL}artifact/Resultats/log.html

                    Cordialement,  
                    Jenkins
                """,
                to: "${params.EMAIL}",
                attachmentsPattern: 'Resultats/rapport_robot.zip'
            )
        }
    }
}
