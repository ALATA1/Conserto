pipeline {
    agent any

    environment {
        PYTHON = 'C:\\Users\\ibrahima.alata\\AppData\\Local\\Programs\\Python\\Python313\\python.exe'
    }

    triggers {
        cron('H 8 * * 1-5')  // Tous les jours ouvr√©s √† 8h
    }

    parameters {
        string(name: 'EMAIL', defaultValue: 'ibrahima.alata@conserto.pro', description: 'Destinataire du rapport')
    }

    stages {
        stage('Installation des d√©pendances') {
            steps {
                echo 'Installation des librairies n√©cessaires'
                bat "${env.PYTHON} -m pip install --upgrade pip"
                bat "${env.PYTHON} -m pip install -r requirements.txt"
            }
        }

        stage('Ex√©cution des tests') {
            steps {
                echo 'echo "üìÅ Lancement des tests'
                bat "${env.PYTHON} -m robot --outputdir Resultats Tests"
                // bat "${env.PYTHON} -m robot --outputdir Resultats Tests/TestSuites/Conserto/conserto_1.robot"
            }
        }

        stage('Rapport : Archivage + cr√©ation ZIP ') {
            steps {
                echo 'Archivage des fichiers de test et üì¶ Cr√©ation du ZIP √† voir dans  : C:\ProgramData\Jenkins\.jenkins\workspace\Conserto\Resultats'
                archiveArtifacts artifacts: 'Resultats/**/*.*', allowEmptyArchive: true
                bat 'powershell Compress-Archive -Path Resultats\\* -DestinationPath Resultats\\rapport_robot.zip'
            }
        }

        // stage('Cr√©er archive ZIP du rapport') {
        //     steps {
        //         echo "üì¶ Cr√©ation du ZIP √† voir dans  : C:\ProgramData\Jenkins\.jenkins\workspace\Conserto\Resultats"
        //         bat 'powershell Compress-Archive -Path Resultats\\* -DestinationPath Resultats\\rapport_robot.zip'
        //     }
        // }

        stage('Rapport-Publisher') {
            steps {
                echo 'Pipeline termin√©.'
                robot outputPath: 'Resultats'
                archiveArtifacts artifacts: 'Resultats/*.html'
            }
        }
    }

    post {
        success {
            emailext (
                subject: "‚úÖ SUCC√àS - Rapport de test ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    Bonjour,

                    Le build *${env.JOB_NAME}* #${env.BUILD_NUMBER} a √©t√© ex√©cut√© avec **succ√®s**.

                    üìé Rapport HTML : ${env.BUILD_URL}artifact/Resultats/log.html  
                    üìÅ Rapport ZIP en pi√®ce jointe.

                    Cordialement,  
                    Jenkins
                """,
                to: "${params.EMAIL}",
                attachmentsPattern: 'Resultats/rapport_robot.zip'
            )
        }

        failure {
            emailext (
                subject: "‚ùå √âCHEC - Rapport de test ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    Bonjour,

                    Le build *${env.JOB_NAME}* #${env.BUILD_NUMBER} a √©chou√©.

                    üìé Voir logs ici : ${env.BUILD_URL}console  
                    üìé Rapport HTML (s'il existe) : ${env.BUILD_URL}artifact/Resultats/log.html

                    Cordialement,  
                    Jenkins
                """,
                to: "${params.EMAIL}",
                attachmentsPattern: 'Resultats/rapport_robot.zip'
            )
        }
    }
}
